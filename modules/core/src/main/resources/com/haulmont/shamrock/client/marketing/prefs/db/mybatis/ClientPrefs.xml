<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.haulmont.shamrock.client.marketing.prefs.mybatis">

    <resultMap id="ClientPrefsMap" type="com.haulmont.shamrock.client.marketing.prefs.storage.model.ClientPrefs">
        <id property="clientId" column="client_id"/>
        <result property="clientUid" column="client_uid"/>
        <result property="clientEmail" column="client_email"/>
        <result property="prefs" column="prefs"/>
    </resultMap>

    <sql id="selectClientPrefs">
        select client_id, client_uid, client_email, prefs from client_prefs
    </sql>

    <select id="getClientPrefs" resultMap="ClientPrefsMap"
            parameterType="com.haulmont.shamrock.client.marketing.prefs.storage.model.ClientId">
        <include refid="selectClientPrefs"/>
        where delete_ts is null
        <if test="id != null">
            and client_id = #{id}::uuid
        </if>
        <if test="uid != null">
            and client_uid = #{uid}
        </if>
        <if test="(id == null and uid != null) and email != null">
            and client_email = #{email}
        </if>
        order by update_ts desc nulls last
        limit 1
    </select>

    <update id="addClientPrefs-recover-deleted" parameterType="com.haulmont.shamrock.client.marketing.prefs.storage.model.ClientPrefs">
        <![CDATA[
            update client_prefs cp set
                create_ts = now(),
                created_by = '${@com.haulmont.shamrock.client.marketing.prefs.mybatis.Constants@USER_NAME}',
                update_ts = now(),
                updated_by = '${@com.haulmont.shamrock.client.marketing.prefs.mybatis.Constants@USER_NAME}',
                delete_ts = null,
                deleted_by = null,
        ]]>
        <![CDATA[
            client_id = #{clientId}::uuid,
            client_uid = #{clientUid},
            client_email = #{clientEmail},
            prefs = #{prefs}::jsonb
        ]]>
        <![CDATA[
            from (
              select client_id, client_uid, client_email
              from client_prefs
              where delete_ts is not null
        ]]>
        <if test="clientId != null">
            and client_id = #{clientId}::uuid
        </if>
        <if test="clientUid != null">
            and client_uid = #{clientUid}
        </if>
        <if test="(clientId == null and clientUid != null) and clientEmail != null">
            and client_email = #{clientEmail}
        </if>
        <![CDATA[
              order by update_ts desc nulls last
              limit 1
            ) sub
            where cp.delete_ts is not null
              and (cp.client_id is not distinct from sub.client_id)
              and (cp.client_uid is not distinct from sub.client_uid)
              and (cp.client_email is not distinct from sub.client_email)
        ]]>
    </update>

    <insert id="addClientPrefs-add-new" parameterType="com.haulmont.shamrock.client.marketing.prefs.storage.model.ClientPrefs">
        <![CDATA[
            insert into client_prefs (client_id, client_uid, client_email, create_ts, created_by, update_ts, updated_by, prefs)
            values (
                #{clientId}::uuid, #{clientUid}, #{clientEmail},
                now(), '${@com.haulmont.shamrock.client.marketing.prefs.db.mybatis.Constants@USER_NAME}',
                now(), '${@com.haulmont.shamrock.client.marketing.prefs.db.mybatis.Constants@USER_NAME}',
                #{prefs}::jsonb
            )
        ]]>
    </insert>

    <update id="updateClientPrefs" parameterType="Map">
        update client_prefs cp set
        <trim suffixOverrides=",">
            update_ts = now(),
            updated_by = '${@com.haulmont.shamrock.client.marketing.prefs.mybatis.Constants@USER_NAME}',
            <if test="value.clientId != null">
                client_id = #{value.clientId}::uuid,
            </if>
            <if test="value.clientUid != null">
                client_uid = #{value.clientUid},
            </if>
            <if test="value.clientEmail != null">
                client_email = #{value.clientEmail},
            </if>
            <if test="value.prefs != null">
                prefs = #{value.prefs}::jsonb,
            </if>
        </trim>
        <![CDATA[
            from (
              select client_id, client_uid, client_email
              from client_prefs
              where delete_ts is null
        ]]>
        <if test="key.id != null">
            and client_id = #{key.id}::uuid
        </if>
        <if test="key.uid != null">
            and client_uid = #{key.uid}
        </if>
        <if test="(key.id == null and key.uid != null) and key.email != null">
            and client_email = #{key.email}
        </if>
        <![CDATA[
              order by update_ts desc nulls last
              limit 1
            ) sub
            where cp.delete_ts is null
              and (cp.client_id is not distinct from sub.client_id)
              and (cp.client_uid is not distinct from sub.client_uid)
              and (cp.client_email is not distinct from sub.client_email)
        ]]>
    </update>

    <update id="deleteClientPrefs" parameterType="com.haulmont.shamrock.client.marketing.prefs.storage.model.ClientId">
        update client_prefs
        set delete_ts = now(), deleted_by = '${@com.haulmont.shamrock.client.marketing.prefs.mybatis.Constants@USER_NAME}'
        where delete_ts is null
        <if test="id != null">
            and client_id = #{id}::uuid
        </if>
        <if test="uid != null">
            and client_uid = #{uid}
        </if>
        <if test="(id == null and uid != null) and email != null">
            and client_email = #{email}
        </if>
    </update>

</mapper>